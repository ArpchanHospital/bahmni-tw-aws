---
- name: add mysql 5.6 yum repo
  template:
    src=mysql.repo.j2
    dest=/etc/yum.repos.d/mysql.repo

- name: Install python mysql for ansible
  yum: name=MySQL-python state=present

- name: Check if any version of mysql is present
  command: mysql --version
  register: mysqlVersion
  ignore_errors: true

- name: Uninstall MySQL if 5.6 is absent
  yum: name={{ item }} state=absent
  with_items:
    - mysql-server
    - mysql
  when: mysqlVersion|success and mysqlVersion.stdout.find('5.6') == -1

- name: Install mysql from mysql56 yum repository
  yum: name={{ item }} state=present
  with_items:
    - mysql-community-common
    - mysql-community-libs
    - mysql-community-client
    - mysql-community-server

  when: mysqlVersion|failed or mysqlVersion.stdout.find('5.6') == -1

- name: Create /var/log/mysql directory to store binlogs if it does not exist
  file: path=/var/log/mysql state=directory mode=0755 owner=mysql group=mysql

- name: Stop Mysql Service
  service: name=mysqld state=stopped

- name: Start Mysql Service
  service: name=mysqld state=started enabled=true

- name: Update mysql root password
  mysql_user: name=root
              password="{{ mysql_root_password }}"
              check_implicit_admin=yes
              login_user=root
              login_password="{{ mysql_old_root_password }}"
              state=present
  ignore_errors: yes

- name: Create /db-restore
  file:
    path=/db-restore
    state=directory

- name: Download openerp dbdump
  get_url:
    url: https://github.com/Bahmni/emr-functional-tests/blob/master/dbdump/openerp_backup.sql.gz?raw=true
    dest: /db-restore
    owner: go
    group: go
    mode: 0644

- name: Drop openerp database
  postgresql_db:
    name=openerp
    state=absent
    login_user=postgres

- name: Restore openerp db
  shell: gunzip -c /db-restore/openerp_backup.sql.gz | psql -U postgres

- name: Create postgres user
  postgresql_user: name={{ postgres_user }} role_attr_flags=CREATEDB,NOCREATEROLE,SUPERUSER,REPLICATION
  sudo_user: postgres
  when: postgres_user is defined and (inventory_hostname in groups['bahmni-lab-db'] or inventory_hostname in groups['bahmni-erp-db'] or inventory_hostname in groups['pacs-integration-db'] or inventory_hostname in groups['dcm4chee-db'])
